{
  "hash": "eb5e7005aad81104355d89a0b7d1ba51",
  "result": {
    "engine": "jupyter",
    "markdown": "---\nformat:\n  html:\n    code-fold: false\necho: true\n---\n\n# The Whole Game {#sec-whole-game}\n\nThis chapter on the main website is a high-level tour of the modeling process.\nWe'll follow the same pattern here by analyzing the same data.\nBut in Python!\nWe won't be able to reproduce everything, but at a high level you'll see the same key points, and how common python packages work.\n\n## Load the Data\n\nStart by loading the data;^[\nWe've opted to use the comma-separated values (CSV) format\nbecause that's easily loaded in many programs;\nthere are other formats that hold more information (like column data types)\nand are more efficient.]\npandas is the standard dataframe package in python.^[\nbut again, fancier things exist, perhaps most notably `polars`\n]\n\n::: {#load-data-from-root .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd\ndeliveries = pd.read_csv(\"data/deliveries.csv\", index_col=0)\ndeliveries.head()\n```\n:::\n\n\n::: {#c3deaa06 .cell execution_count=2}\n\n::: {.cell-output .cell-output-display execution_count=1}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>time_to_delivery</th>\n      <th>hour</th>\n      <th>day</th>\n      <th>distance</th>\n      <th>item_01</th>\n      <th>item_02</th>\n      <th>item_03</th>\n      <th>item_04</th>\n      <th>item_05</th>\n      <th>item_06</th>\n      <th>...</th>\n      <th>item_18</th>\n      <th>item_19</th>\n      <th>item_20</th>\n      <th>item_21</th>\n      <th>item_22</th>\n      <th>item_23</th>\n      <th>item_24</th>\n      <th>item_25</th>\n      <th>item_26</th>\n      <th>item_27</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>1</th>\n      <td>16.1106</td>\n      <td>11.899</td>\n      <td>Thu</td>\n      <td>3.15</td>\n      <td>0</td>\n      <td>0</td>\n      <td>2</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>...</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>22.9466</td>\n      <td>19.230</td>\n      <td>Tue</td>\n      <td>3.69</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>...</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>30.2882</td>\n      <td>18.374</td>\n      <td>Fri</td>\n      <td>2.06</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>...</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>33.4266</td>\n      <td>15.836</td>\n      <td>Thu</td>\n      <td>5.97</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>...</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>27.2255</td>\n      <td>19.619</td>\n      <td>Fri</td>\n      <td>2.52</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>0</td>\n      <td>...</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>0</td>\n      <td>1</td>\n    </tr>\n  </tbody>\n</table>\n<p>5 rows × 31 columns</p>\n</div>\n```\n:::\n:::\n\n\npandas provides plotting utilities, wrapping matplotlib:\n\n::: {#cell-fig-histogram-of-outcome .cell execution_count=3}\n``` {.python .cell-code}\nfrom matplotlib import pyplot as plt\nimport numpy as np\nfig, ax = plt.subplots(1, 2, sharey=True)\ndeliveries['time_to_delivery'].hist(bins=30, ax=ax[0], label=\"time to delivery\")\ndeliveries['time_to_delivery'].apply(np.log).hist(bins=30, ax=ax[1], label=\"log(time to delivery)\")\nax[0].set_xlabel(\"time_to_delivery\")\nax[1].set_xlabel(\"log(time_to_delivery)\")\nax[0].set_ylabel(\"count\")\nplt.show();\n```\n\n::: {.cell-output .cell-output-display}\n![](whole-game_files/figure-html/fig-histogram-of-outcome-output-1.png){#fig-histogram-of-outcome width=527 height=374}\n:::\n:::\n\n\nReading from a CSV can't intuit everything we'd like.\nThe `day` column, the day of the week, was loaded as strings.\nIt'll be helpful in some places to cast them to a `categorical` type.\n\n::: {#day-to-ordinal .cell execution_count=4}\n``` {.python .cell-code}\ndeliveries['day'] = (\n    deliveries['day']\n    .astype('category')\n    .cat.set_categories(\n        ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],\n        ordered=True,\n    )\n)\n```\n:::\n\n\n## Data Spending\n\nsklearn provides `train_test_split` for simple splits, and several other cross-validation generators.\n\n`train_test_split` doesn't currently support stratifying on a continuous outcome.\nIt's probably not really needed here: with a large dataset randomness will generally work just fine.\nBut we can stratify on the binned outcome^[\n  we use quartiles to match tidymodels, see [docs](https://rsample.tidymodels.org/reference/initial_validation_split.html#arguments)\n]:\n\n::: {#data-split .cell execution_count=5}\n``` {.python .cell-code}\nfrom sklearn.model_selection import train_test_split\ndelivery_train_val, delivery_test = train_test_split(\n    deliveries,\n    test_size=0.2,\n    random_state=42,\n    stratify=pd.qcut(deliveries['time_to_delivery'], 4),\n)\ndelivery_train, delivery_val = train_test_split(\n    delivery_train_val,\n    test_size=0.2 / 0.8,\n    random_state=42,\n    stratify=pd.qcut(delivery_train_val['time_to_delivery'], 4),\n)\n\nprint(len(delivery_train), len(delivery_val), len(delivery_test))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n6006 2003 2003\n```\n:::\n:::\n\n\n## Exploratory Data Analysis\n\n### Distance and datetime features\n\nPlotting smoothed trendlines isn't so easy in pandas+matplotlib^[\nthe latter [have expressed concern](https://github.com/matplotlib/matplotlib/issues/19384#issuecomment-768674677)\nover making up information\nas well as possibly exploding the number of parameters needed for different uses];\nfor now we avoid additional packages, \nrelying on just the scatter plots in the top charts\nand adding a binned trend line for hour-vs-day interaction.\n\n::: {#cell-fig-eda-plots .cell execution_count=6}\n``` {.python .cell-code}\nfrom matplotlib import pyplot as plt\n\nfig, ax = plt.subplots(2, 2, figsize=(8, 6))\n\ndelivery_train.plot.scatter(\n    x='distance',\n    y='time_to_delivery',\n    alpha=0.1,\n    ax=ax[0, 0],\n)\n\ndelivery_train.plot.scatter(\n    x='hour',\n    y='time_to_delivery',\n    alpha=0.1,\n    ax=ax[0, 1],\n)\nax[0, 1].set_ylabel('')\n\ndelivery_train.boxplot(\n    column='time_to_delivery',\n    by='day',\n    ax=ax[1, 0],\n)\nax[1, 0].set_title('')\n\n\n# without fitting smoothers (another plotting package would help here),\n# we'll bin the `hour` per `day` and line-plot the mean target\ntemp = delivery_train.copy()\ntemp['hour_bin'] = (\n    temp['hour']\n    .transform(pd.qcut, q=8)\n    .apply(lambda x: x.mid)\n    .astype('float')\n)\ngrouped = (\n    temp\n    .groupby(['day', 'hour_bin'], observed=True)\n    ['time_to_delivery']\n    .mean()\n    .reset_index('hour_bin')\n    .groupby('day', observed=True)\n)\nfor day, data in grouped:\n    data.plot.line(x='hour_bin', y='time_to_delivery', label=day, ax=ax[1, 1])\nplt.legend()\n\nplt.tight_layout()\nplt.suptitle('EDA plots')\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](whole-game_files/figure-html/fig-eda-plots-output-1.png){#fig-eda-plots width=758 height=569}\n:::\n:::\n\n\n### Bootstrap confidence intervals for item effects\n\n\n\nDefine the metric, make bootstrap samples and apply the metric:\n\n::: {#cdedd379 .cell execution_count=8}\n``` {.python .cell-code}\ndef rel_increase_time_item(df, col):\n    \"\"\"Computes the relative increase to delivery time when\n    the item for column `col` is present.\"\"\"\n    return (\n        df[['time_to_delivery']]\n        .groupby(df[col] > 0)\n        .mean()\n        .apply(lambda x: x[True] / x[False] - 1)\n        .item()\n    )\n\nresample_stats = []\nfor _ in range(1001):\n    resample = delivery_train.sample(frac=1, replace=True)\n    stat = {}\n    for col in [col for col in resample.columns if col[:5] == \"item_\"]:\n        stat[col] = rel_increase_time_item(resample, col)\n    resample_stats.append(stat)\nresample_stats = pd.DataFrame(resample_stats)\nresample_stats.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>item_01</th>\n      <th>item_02</th>\n      <th>item_03</th>\n      <th>item_04</th>\n      <th>item_05</th>\n      <th>item_06</th>\n      <th>item_07</th>\n      <th>item_08</th>\n      <th>item_09</th>\n      <th>item_10</th>\n      <th>...</th>\n      <th>item_18</th>\n      <th>item_19</th>\n      <th>item_20</th>\n      <th>item_21</th>\n      <th>item_22</th>\n      <th>item_23</th>\n      <th>item_24</th>\n      <th>item_25</th>\n      <th>item_26</th>\n      <th>item_27</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0.054103</td>\n      <td>0.017292</td>\n      <td>0.008682</td>\n      <td>0.015977</td>\n      <td>0.011972</td>\n      <td>0.043665</td>\n      <td>0.036624</td>\n      <td>0.012765</td>\n      <td>0.021645</td>\n      <td>0.062728</td>\n      <td>...</td>\n      <td>0.013388</td>\n      <td>-0.014932</td>\n      <td>0.014990</td>\n      <td>0.041886</td>\n      <td>0.034494</td>\n      <td>0.014592</td>\n      <td>0.015965</td>\n      <td>0.020034</td>\n      <td>0.020984</td>\n      <td>0.049516</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0.050011</td>\n      <td>0.002393</td>\n      <td>-0.001299</td>\n      <td>0.001282</td>\n      <td>-0.010490</td>\n      <td>0.001923</td>\n      <td>0.038826</td>\n      <td>0.007291</td>\n      <td>0.023146</td>\n      <td>0.066698</td>\n      <td>...</td>\n      <td>0.015118</td>\n      <td>-0.019182</td>\n      <td>0.016508</td>\n      <td>0.022857</td>\n      <td>0.022154</td>\n      <td>0.016174</td>\n      <td>0.032608</td>\n      <td>0.031186</td>\n      <td>0.041065</td>\n      <td>0.037091</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0.064525</td>\n      <td>0.021489</td>\n      <td>0.012805</td>\n      <td>-0.001155</td>\n      <td>-0.006744</td>\n      <td>0.017456</td>\n      <td>0.021495</td>\n      <td>0.013350</td>\n      <td>0.010477</td>\n      <td>0.079519</td>\n      <td>...</td>\n      <td>0.026898</td>\n      <td>-0.017919</td>\n      <td>-0.000028</td>\n      <td>0.041610</td>\n      <td>0.047812</td>\n      <td>0.036134</td>\n      <td>0.029307</td>\n      <td>0.007808</td>\n      <td>0.032878</td>\n      <td>0.048277</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0.066122</td>\n      <td>0.017269</td>\n      <td>0.003352</td>\n      <td>0.004768</td>\n      <td>-0.001041</td>\n      <td>0.039762</td>\n      <td>0.029516</td>\n      <td>0.018215</td>\n      <td>0.035621</td>\n      <td>0.055254</td>\n      <td>...</td>\n      <td>0.025648</td>\n      <td>-0.043171</td>\n      <td>0.032758</td>\n      <td>0.003911</td>\n      <td>0.033549</td>\n      <td>0.038567</td>\n      <td>0.029270</td>\n      <td>0.018654</td>\n      <td>0.045651</td>\n      <td>0.044264</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0.052150</td>\n      <td>0.008242</td>\n      <td>-0.000876</td>\n      <td>0.005176</td>\n      <td>-0.016159</td>\n      <td>0.004438</td>\n      <td>0.003848</td>\n      <td>0.013680</td>\n      <td>0.013857</td>\n      <td>0.046125</td>\n      <td>...</td>\n      <td>0.012379</td>\n      <td>-0.043789</td>\n      <td>0.017621</td>\n      <td>0.014498</td>\n      <td>0.017912</td>\n      <td>0.019515</td>\n      <td>0.021430</td>\n      <td>0.022849</td>\n      <td>0.032541</td>\n      <td>0.029674</td>\n    </tr>\n  </tbody>\n</table>\n<p>5 rows × 27 columns</p>\n</div>\n```\n:::\n:::\n\n\nDefine the confidence intervals:\n\n::: {#06f807b2 .cell execution_count=9}\n``` {.python .cell-code}\nci = resample_stats.apply(np.percentile, q=[5, 95])\nci.index = ['lower', 'upper']\n\nci = ci.T\nci['sample'] = [\n    rel_increase_time_item(delivery_train, col)\n    for col in delivery_train.columns if col[:5] == \"item_\"\n]\nci = ci.sort_values('sample')\n```\n:::\n\n\nPlot:\n\n::: {#cell-fig-item-effects .cell execution_count=10}\n``` {.python .cell-code}\nfig = plt.figure(figsize=(5, 12))\nfor y, (col, stats) in enumerate(ci.iterrows()):\n    plt.plot([stats['lower'], stats['upper']], [y, y], c='b')\n    plt.plot(stats['sample'], y, 'bo')\nplt.axvline(0, ls='--', c='r', alpha=0.2)\nplt.yticks(np.arange(len(ci)), labels=ci.index)\nplt.xlabel(\"Increase in delivery time when ordered\")\n\nplt.show();\n```\n\n::: {.cell-output .cell-output-display}\n![](whole-game_files/figure-html/fig-item-effects-output-1.png){#fig-item-effects width=454 height=947}\n:::\n:::\n\n\n## Model Development\n\nsklearn uses separate parameter slots for its independent and dependent variables, so\n\n::: {#43748608 .cell execution_count=11}\n``` {.python .cell-code}\ny_var = 'time_to_delivery'\nX_train = delivery_train.drop(columns=y_var)\nX_val = delivery_val.drop(columns=y_var)\nX_test = delivery_test.drop(columns=y_var)\ny_train = delivery_train[y_var]\ny_val = delivery_val[y_var]\ny_test = delivery_test[y_var]\n```\n:::\n\n\n### Linear model\n\nWe use sklearn's `OneHotEncoder` to produce indicator columns (a.k.a. dummy variables, one-hot encoding) for the `day` variable.\n(pandas also has `make_dummies`, but this requires more work with the validation and test sets (and production),\nso we prefer to keep everything in sklearn.)\n\nFor splines, we have `SplineTransformer`.\n\nFor interaction terms, there's not a direct sklearn transformer.\nWe'll use a `FunctionTransformer` and define the transformation function directly.^[\n  We could also use `PolynomialFeatures` here,\n  with degree 2 and `interaction_only=True` to prevent $\\mathrm{feature}^2$ terms;\n  that would include things like\n  interactions of Monday with Wednesday,\n  or two spline bases,\n  which we could probably clean up downstream,\n  but this will be a little nicer.\n]\n\nTo apply preprocessors to different subsets of columns, we use `ColumnTransformer`.\n\n::: {#8665207d .cell execution_count=12}\n``` {.python .cell-code}\nfrom sklearn import set_config\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.compose import ColumnTransformer\nfrom sklearn.preprocessing import OneHotEncoder, SplineTransformer, FunctionTransformer\n\nset_config(transform_output=\"pandas\")\n\nohe = OneHotEncoder(\n    sparse_output=False,\n    handle_unknown='ignore',\n)\nspl = SplineTransformer(knots='quantile')\n\ndef interactions(X):\n    for day_col in [col for col in X.columns if col[:4] == 'day_']:\n        for hour_basis in [col for col in X.columns if col[:5] == 'hour_']:\n            X[f'{day_col}*{hour_basis}'] = X[day_col] * X[hour_basis]\n    return X\n\nint_tfm = FunctionTransformer(interactions, check_inverse=False)\n\npreproc_lr = Pipeline([\n    ('step_1', ColumnTransformer(\n        [\n            ('ohe', ohe, ['day']),\n            ('spl', spl, ['hour']),\n        ],\n        remainder='passthrough',\n        verbose_feature_names_out=False,\n        )\n    ),\n    ('interact', int_tfm),\n])\n\npreproc_lr\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n```{=html}\n<style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: \"▸\";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: \"▾\";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: \"\";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: \"\";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: \"\";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id=\"sk-container-id-1\" class=\"sk-top-container\"><div class=\"sk-text-repr-fallback\"><pre>Pipeline(steps=[(&#x27;step_1&#x27;,\n                 ColumnTransformer(remainder=&#x27;passthrough&#x27;,\n                                   transformers=[(&#x27;ohe&#x27;,\n                                                  OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                                                sparse_output=False),\n                                                  [&#x27;day&#x27;]),\n                                                 (&#x27;spl&#x27;,\n                                                  SplineTransformer(knots=&#x27;quantile&#x27;),\n                                                  [&#x27;hour&#x27;])],\n                                   verbose_feature_names_out=False)),\n                (&#x27;interact&#x27;,\n                 FunctionTransformer(check_inverse=False,\n                                     func=&lt;function interactions at 0x00000162F512AFC0&gt;))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class=\"sk-container\" hidden><div class=\"sk-item sk-dashed-wrapped\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-1\" type=\"checkbox\" ><label for=\"sk-estimator-id-1\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">Pipeline</label><div class=\"sk-toggleable__content\"><pre>Pipeline(steps=[(&#x27;step_1&#x27;,\n                 ColumnTransformer(remainder=&#x27;passthrough&#x27;,\n                                   transformers=[(&#x27;ohe&#x27;,\n                                                  OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                                                sparse_output=False),\n                                                  [&#x27;day&#x27;]),\n                                                 (&#x27;spl&#x27;,\n                                                  SplineTransformer(knots=&#x27;quantile&#x27;),\n                                                  [&#x27;hour&#x27;])],\n                                   verbose_feature_names_out=False)),\n                (&#x27;interact&#x27;,\n                 FunctionTransformer(check_inverse=False,\n                                     func=&lt;function interactions at 0x00000162F512AFC0&gt;))])</pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item sk-dashed-wrapped\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-2\" type=\"checkbox\" ><label for=\"sk-estimator-id-2\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">step_1: ColumnTransformer</label><div class=\"sk-toggleable__content\"><pre>ColumnTransformer(remainder=&#x27;passthrough&#x27;,\n                  transformers=[(&#x27;ohe&#x27;,\n                                 OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                               sparse_output=False),\n                                 [&#x27;day&#x27;]),\n                                (&#x27;spl&#x27;, SplineTransformer(knots=&#x27;quantile&#x27;),\n                                 [&#x27;hour&#x27;])],\n                  verbose_feature_names_out=False)</pre></div></div></div><div class=\"sk-parallel\"><div class=\"sk-parallel-item\"><div class=\"sk-item\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-3\" type=\"checkbox\" ><label for=\"sk-estimator-id-3\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">ohe</label><div class=\"sk-toggleable__content\"><pre>[&#x27;day&#x27;]</pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-4\" type=\"checkbox\" ><label for=\"sk-estimator-id-4\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">OneHotEncoder</label><div class=\"sk-toggleable__content\"><pre>OneHotEncoder(handle_unknown=&#x27;ignore&#x27;, sparse_output=False)</pre></div></div></div></div></div></div><div class=\"sk-parallel-item\"><div class=\"sk-item\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-5\" type=\"checkbox\" ><label for=\"sk-estimator-id-5\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">spl</label><div class=\"sk-toggleable__content\"><pre>[&#x27;hour&#x27;]</pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-6\" type=\"checkbox\" ><label for=\"sk-estimator-id-6\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">SplineTransformer</label><div class=\"sk-toggleable__content\"><pre>SplineTransformer(knots=&#x27;quantile&#x27;)</pre></div></div></div></div></div></div><div class=\"sk-parallel-item\"><div class=\"sk-item\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-7\" type=\"checkbox\" ><label for=\"sk-estimator-id-7\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">remainder</label><div class=\"sk-toggleable__content\"><pre></pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-8\" type=\"checkbox\" ><label for=\"sk-estimator-id-8\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">passthrough</label><div class=\"sk-toggleable__content\"><pre>passthrough</pre></div></div></div></div></div></div></div></div><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-9\" type=\"checkbox\" ><label for=\"sk-estimator-id-9\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">FunctionTransformer</label><div class=\"sk-toggleable__content\"><pre>FunctionTransformer(check_inverse=False,\n                    func=&lt;function interactions at 0x00000162F512AFC0&gt;)</pre></div></div></div></div></div></div></div>\n```\n:::\n:::\n\n\nAll sklearn estimators (both transformers and model objects) implement a `fit` method that learns statistics/parameters from the data.  Transformers provide `transform` for applying their transformations to data (whether training or test data; for training data, `fit_transform` is available and most often means just `fit` then `transform`).  Model objects provide `predict` (and probabilistic classifiers provide `predict_proba`).  There are many other methods and attributes, but these will get us through the rest of this chapter.\n\nLet's see what the fully preprocessed data looks like.\n\n::: {#6ae05ee3 .cell execution_count=13}\n``` {.python .cell-code}\npreproc_lr.fit_transform(X_train)\n```\n\n::: {.cell-output .cell-output-display execution_count=12}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>day_Fri</th>\n      <th>day_Mon</th>\n      <th>day_Sat</th>\n      <th>day_Sun</th>\n      <th>day_Thu</th>\n      <th>day_Tue</th>\n      <th>day_Wed</th>\n      <th>hour_sp_0</th>\n      <th>hour_sp_1</th>\n      <th>hour_sp_2</th>\n      <th>...</th>\n      <th>day_Tue*hour_sp_4</th>\n      <th>day_Tue*hour_sp_5</th>\n      <th>day_Tue*hour_sp_6</th>\n      <th>day_Wed*hour_sp_0</th>\n      <th>day_Wed*hour_sp_1</th>\n      <th>day_Wed*hour_sp_2</th>\n      <th>day_Wed*hour_sp_3</th>\n      <th>day_Wed*hour_sp_4</th>\n      <th>day_Wed*hour_sp_5</th>\n      <th>day_Wed*hour_sp_6</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>5732</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>4480</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.006219</td>\n      <td>0.294690</td>\n      <td>0.612966</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>7337</th>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.015240</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>8762</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>931</th>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.008700</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>2742</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.035889</td>\n      <td>0.480137</td>\n      <td>0.465214</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>8232</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.000036</td>\n      <td>0.120192</td>\n      <td>0.637531</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>6660</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.002236</td>\n      <td>0.227557</td>\n      <td>0.640921</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>68</th>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.083970</td>\n      <td>0.588468</td>\n      <td>0.325075</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>8066</th>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>1.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.000000</td>\n      <td>0.004694</td>\n      <td>0.295272</td>\n      <td>...</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n      <td>0.0</td>\n    </tr>\n  </tbody>\n</table>\n<p>6006 rows × 91 columns</p>\n</div>\n```\n:::\n:::\n\n\nWe can put that frame directly into a model, or again wrap the preprocessor in a pipeline with the model (which will make predicting slightly easier, as the transformations will happen under the hood).\n\n::: {#37746421 .cell execution_count=14}\n``` {.python .cell-code}\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.metrics import mean_absolute_error\n\npipe_lr = Pipeline([\n    ('preproc', preproc_lr),\n    ('linear_reg', LinearRegression()),\n])\npipe_lr.fit(X_train, y_train)\n\ny_pred = pipe_lr.predict(X_val)\nmean_absolute_error(y_true=y_val, y_pred=y_pred)\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n```\n1.6421489340208437\n```\n:::\n:::\n\n\nTake a look at a calibration plot, the actual-vs-predicted values:\n\n::: {#cell-fig-calibration .cell execution_count=15}\n``` {.python .cell-code}\nfrom sklearn.metrics import PredictionErrorDisplay\nPredictionErrorDisplay.from_predictions(\n    y_true=y_val,\n    y_pred=y_pred,\n    kind='actual_vs_predicted',\n    scatter_kwargs={'alpha': 0.1},\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](whole-game_files/figure-html/fig-calibration-output-1.png){#fig-calibration width=531 height=374}\n:::\n:::\n\n\n### Random forest\n\nsklearn doesn't have a model-based recursive partitioning like cubist;\nthere is a different python package just for that,\nbut to stick to sklearn for now let's fit instead a random forest.\nRandom forests build binary trees like cubist,\nbut with constant predictions from each leaf\n instead of the linear models that cubist produces.\nTo reach similar performance then, we'll want deeper trees.\n\nAs in the book, this tree-based model doesn't necessitate as much transformation to perform well.\nHowever, at time of writing sklearn's random forest doesn't handle categorical features,\nso we'll need to one-hot encode `day` still.\n\nAnd intuitively the _number_ of items ought to also be important;\nwhile the linear model gets that for free (just the sum of the `item_` columns),\nand a tree can approximate it arbitrarily closely,\nit can be beneficial to the learning procedure to expose this as a feature directly.\nWe can add that in the pipeline as another `FunctionTransformer`.\n\n::: {#5793cdb1 .cell execution_count=16}\n``` {.python .cell-code}\nfrom sklearn.ensemble import RandomForestRegressor\nfrom sklearn.preprocessing import FunctionTransformer\nfrom sklearn.compose import make_column_selector\n\nrf = RandomForestRegressor(\n    max_depth=15,\n    n_estimators=100,\n    random_state=42,\n)\n\ndef item_count(X):\n    X['item_count'] = X.sum(axis=1)\n    return X\n\npreproc_rf = ColumnTransformer(\n    [\n        ('ohe', ohe, ['day']),\n        ('items', FunctionTransformer(item_count), make_column_selector(pattern='item_*')),\n    ],\n    remainder='passthrough',\n    verbose_feature_names_out=False,\n)\n\npipe_rf = Pipeline([\n    ('preproc', preproc_rf),\n    ('rand_forest', rf),\n])\n\npipe_rf.fit(X_train, y_train)\n\ny_pred = pipe_rf.predict(X_val)\nmean_absolute_error(y_true=y_val, y_pred=y_pred)\n```\n\n::: {.cell-output .cell-output-display execution_count=15}\n```\n1.4992085511625766\n```\n:::\n:::\n\n\nAdding the item count appears (on the validation set) to have helped a bit.\nTaking into account our analysis of item presence,\nwe might modify the count to exclude item 19,\nor increase the weight on item 10, etc.\nBut at that point the trees might already be making the relevant modifications.\n\n### Neural network\n\nsklearn isn't the best package for neural networks,\nbut it does provide a simple implementation:\n\n::: {#7fe6216c .cell execution_count=17}\n``` {.python .cell-code}\nfrom sklearn.neural_network import MLPRegressor\nnn = MLPRegressor(\n    max_iter=500,\n    learning_rate_init=0.01,\n    random_state=42,\n)\n```\n:::\n\n\nAs in the book, we won't get into the large space of hyperparameters,\nand just tune the number of neurons in a single hidden layer.\nsklearn offers `GridSearchCV` for tuning hyperparameters in a grid style,\nor `RandomizedSearchCV` for a random search.\nOther packages offer other strategies.\n\nThe tuners in sklearn use k-fold cross-validation by default.\nWhile it's possible to tune using a fixed validation set,\nwe'll just use the k-fold splitting of the training set to score hyperparameters,\nand score the best hyperparameter against our validation set.\n\n::: {#be1b4c34 .cell execution_count=18}\n``` {.python .cell-code}\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.preprocessing import StandardScaler\n\npreproc_nn = ColumnTransformer(\n    [('ohe', ohe, ['day'])],\n    remainder=StandardScaler(),\n)\n\npipe_nn = Pipeline([\n    ('preproc', preproc_nn),\n    ('neural_net', nn),\n])\n\n# setting hyperparameters for a pipeline\n# uses <step_name>__<parameter>\nparams = {\n    'neural_net__hidden_layer_sizes': [(k,) for k in range(2, 10)],\n}\n\nsearch = GridSearchCV(\n    estimator=pipe_nn,\n    param_grid=params,\n    cv=3,\n    scoring='neg_mean_absolute_error',\n    n_jobs=3,\n)\n\nsearch.fit(X_train, y_train)\n```\n\n::: {.cell-output .cell-output-display execution_count=17}\n```{=html}\n<style>#sk-container-id-2 {color: black;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: \"▸\";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: \"▾\";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: \"\";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: \"\";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: \"\";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id=\"sk-container-id-2\" class=\"sk-top-container\"><div class=\"sk-text-repr-fallback\"><pre>GridSearchCV(cv=3,\n             estimator=Pipeline(steps=[(&#x27;preproc&#x27;,\n                                        ColumnTransformer(remainder=StandardScaler(),\n                                                          transformers=[(&#x27;ohe&#x27;,\n                                                                         OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                                                                       sparse_output=False),\n                                                                         [&#x27;day&#x27;])])),\n                                       (&#x27;neural_net&#x27;,\n                                        MLPRegressor(learning_rate_init=0.01,\n                                                     max_iter=500,\n                                                     random_state=42))]),\n             n_jobs=3,\n             param_grid={&#x27;neural_net__hidden_layer_sizes&#x27;: [(2,), (3,), (4,),\n                                                            (5,), (6,), (7,),\n                                                            (8,), (9,)]},\n             scoring=&#x27;neg_mean_absolute_error&#x27;)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class=\"sk-container\" hidden><div class=\"sk-item sk-dashed-wrapped\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-10\" type=\"checkbox\" ><label for=\"sk-estimator-id-10\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">GridSearchCV</label><div class=\"sk-toggleable__content\"><pre>GridSearchCV(cv=3,\n             estimator=Pipeline(steps=[(&#x27;preproc&#x27;,\n                                        ColumnTransformer(remainder=StandardScaler(),\n                                                          transformers=[(&#x27;ohe&#x27;,\n                                                                         OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                                                                       sparse_output=False),\n                                                                         [&#x27;day&#x27;])])),\n                                       (&#x27;neural_net&#x27;,\n                                        MLPRegressor(learning_rate_init=0.01,\n                                                     max_iter=500,\n                                                     random_state=42))]),\n             n_jobs=3,\n             param_grid={&#x27;neural_net__hidden_layer_sizes&#x27;: [(2,), (3,), (4,),\n                                                            (5,), (6,), (7,),\n                                                            (8,), (9,)]},\n             scoring=&#x27;neg_mean_absolute_error&#x27;)</pre></div></div></div><div class=\"sk-parallel\"><div class=\"sk-parallel-item\"><div class=\"sk-item\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-11\" type=\"checkbox\" ><label for=\"sk-estimator-id-11\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">estimator: Pipeline</label><div class=\"sk-toggleable__content\"><pre>Pipeline(steps=[(&#x27;preproc&#x27;,\n                 ColumnTransformer(remainder=StandardScaler(),\n                                   transformers=[(&#x27;ohe&#x27;,\n                                                  OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                                                sparse_output=False),\n                                                  [&#x27;day&#x27;])])),\n                (&#x27;neural_net&#x27;,\n                 MLPRegressor(learning_rate_init=0.01, max_iter=500,\n                              random_state=42))])</pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item\"><div class=\"sk-serial\"><div class=\"sk-item sk-dashed-wrapped\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-12\" type=\"checkbox\" ><label for=\"sk-estimator-id-12\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">preproc: ColumnTransformer</label><div class=\"sk-toggleable__content\"><pre>ColumnTransformer(remainder=StandardScaler(),\n                  transformers=[(&#x27;ohe&#x27;,\n                                 OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,\n                                               sparse_output=False),\n                                 [&#x27;day&#x27;])])</pre></div></div></div><div class=\"sk-parallel\"><div class=\"sk-parallel-item\"><div class=\"sk-item\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-13\" type=\"checkbox\" ><label for=\"sk-estimator-id-13\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">ohe</label><div class=\"sk-toggleable__content\"><pre>[&#x27;day&#x27;]</pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-14\" type=\"checkbox\" ><label for=\"sk-estimator-id-14\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">OneHotEncoder</label><div class=\"sk-toggleable__content\"><pre>OneHotEncoder(handle_unknown=&#x27;ignore&#x27;, sparse_output=False)</pre></div></div></div></div></div></div><div class=\"sk-parallel-item\"><div class=\"sk-item\"><div class=\"sk-label-container\"><div class=\"sk-label sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-15\" type=\"checkbox\" ><label for=\"sk-estimator-id-15\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">remainder</label><div class=\"sk-toggleable__content\"><pre></pre></div></div></div><div class=\"sk-serial\"><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-16\" type=\"checkbox\" ><label for=\"sk-estimator-id-16\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">StandardScaler</label><div class=\"sk-toggleable__content\"><pre>StandardScaler()</pre></div></div></div></div></div></div></div></div><div class=\"sk-item\"><div class=\"sk-estimator sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-17\" type=\"checkbox\" ><label for=\"sk-estimator-id-17\" class=\"sk-toggleable__label sk-toggleable__label-arrow\">MLPRegressor</label><div class=\"sk-toggleable__content\"><pre>MLPRegressor(learning_rate_init=0.01, max_iter=500, random_state=42)</pre></div></div></div></div></div></div></div></div></div></div></div></div>\n```\n:::\n:::\n\n\nBy default, the hyperparameter(s) with the highest score are selected as `best_params_`,\nand a new model is trained with that setting on the entire training set.\nThat model object is used when calling `search.predict` below.\n\n::: {#1312bea7 .cell execution_count=19}\n``` {.python .cell-code}\ny_pred = search.predict(X_val)\nmean_absolute_error(y_true=y_val, y_pred=y_pred)\n```\n\n::: {.cell-output .cell-output-display execution_count=18}\n```\n1.5896399846317644\n```\n:::\n:::\n\n\nTo find out more about the search, we have a look at the attribute `cv_results_`:\n\n::: {#fb0f11aa .cell execution_count=20}\n``` {.python .cell-code}\ncv_results_frame = pd.DataFrame(search.cv_results_)\ncv_results_frame\n```\n\n::: {.cell-output .cell-output-display execution_count=19}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>mean_fit_time</th>\n      <th>std_fit_time</th>\n      <th>mean_score_time</th>\n      <th>std_score_time</th>\n      <th>param_neural_net__hidden_layer_sizes</th>\n      <th>params</th>\n      <th>split0_test_score</th>\n      <th>split1_test_score</th>\n      <th>split2_test_score</th>\n      <th>mean_test_score</th>\n      <th>std_test_score</th>\n      <th>rank_test_score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>2.053400</td>\n      <td>0.386802</td>\n      <td>0.026926</td>\n      <td>0.004126</td>\n      <td>(2,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (2,)}</td>\n      <td>-2.900021</td>\n      <td>-2.968643</td>\n      <td>-2.878729</td>\n      <td>-2.915798</td>\n      <td>0.038365</td>\n      <td>8</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>2.036068</td>\n      <td>0.267483</td>\n      <td>0.029154</td>\n      <td>0.003246</td>\n      <td>(3,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (3,)}</td>\n      <td>-2.891706</td>\n      <td>-2.955277</td>\n      <td>-2.898843</td>\n      <td>-2.915275</td>\n      <td>0.028435</td>\n      <td>7</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>6.717807</td>\n      <td>0.391012</td>\n      <td>0.022901</td>\n      <td>0.001156</td>\n      <td>(4,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (4,)}</td>\n      <td>-2.813088</td>\n      <td>-2.892844</td>\n      <td>-2.797502</td>\n      <td>-2.834478</td>\n      <td>0.041758</td>\n      <td>6</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>2.319414</td>\n      <td>0.103762</td>\n      <td>0.027622</td>\n      <td>0.002060</td>\n      <td>(5,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (5,)}</td>\n      <td>-1.890891</td>\n      <td>-3.093606</td>\n      <td>-2.883853</td>\n      <td>-2.622783</td>\n      <td>0.524563</td>\n      <td>5</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>2.758142</td>\n      <td>0.920328</td>\n      <td>0.028804</td>\n      <td>0.003179</td>\n      <td>(6,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (6,)}</td>\n      <td>-1.813454</td>\n      <td>-1.834016</td>\n      <td>-1.823665</td>\n      <td>-1.823712</td>\n      <td>0.008395</td>\n      <td>3</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>3.745881</td>\n      <td>0.316166</td>\n      <td>0.037313</td>\n      <td>0.007820</td>\n      <td>(7,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (7,)}</td>\n      <td>-1.826556</td>\n      <td>-1.791720</td>\n      <td>-1.811093</td>\n      <td>-1.809790</td>\n      <td>0.014252</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>6</th>\n      <td>4.488394</td>\n      <td>1.265043</td>\n      <td>0.026785</td>\n      <td>0.004012</td>\n      <td>(8,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (8,)}</td>\n      <td>-2.854357</td>\n      <td>-1.600081</td>\n      <td>-1.799832</td>\n      <td>-2.084757</td>\n      <td>0.550265</td>\n      <td>4</td>\n    </tr>\n    <tr>\n      <th>7</th>\n      <td>3.707190</td>\n      <td>0.577736</td>\n      <td>0.022616</td>\n      <td>0.003156</td>\n      <td>(9,)</td>\n      <td>{'neural_net__hidden_layer_sizes': (9,)}</td>\n      <td>-1.700333</td>\n      <td>-1.715514</td>\n      <td>-1.662616</td>\n      <td>-1.692821</td>\n      <td>0.022239</td>\n      <td>1</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nPlotting from that dataframe:\n\n::: {#cell-fig-NN-hyperparameter-results .cell execution_count=21}\n``` {.python .cell-code}\n# extract the numeric hidden layer size\n# from the tuple-typed hyperparameter\ncv_results_frame['hidden_layer_size'] = cv_results_frame[\n    'param_neural_net__hidden_layer_sizes'\n].apply(lambda x: x[0])\n\n# convert back from scorer neg_mae to mae\ncv_results_frame[[f'split{i}_mae' for i in range(search.cv)]] = (\n    - cv_results_frame[[f'split{i}_test_score' for i in range(search.cv)]]\n)\n\nfrom matplotlib import colormaps\ncolors = colormaps['tab10'].colors\nfig, ax = plt.subplots(1)\nfor i in range(search.cv):\n    cv_results_frame.plot.scatter(\n        x='hidden_layer_size',\n        y=f'split{i}_mae',\n        label=f'split {i}',\n        color=colors[i],\n        ax=ax,\n    )\nplt.legend()\nax.set_ylabel(\"MAE\")\nplt.show();\n```\n\n::: {.cell-output .cell-output-display}\n![](whole-game_files/figure-html/fig-nn-hyperparameter-results-output-1.png){#fig-nn-hyperparameter-results width=515 height=374}\n:::\n:::\n\n\n",
    "supporting": [
      "whole-game_files\\figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}